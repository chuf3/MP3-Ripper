<!doctype html>
<html lang="en">
<head>
  <title>Edit – Lisa's MP3 Ripper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root { --accent: #d63384; }
    body { font-family: system-ui, sans-serif; background:#f6f7f9; padding:16px; }
    .container { max-width:700px; margin:auto; background:#fff; padding:16px;
                 border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    h2 { color:var(--accent); margin-top:0; }
    audio { width:100%; margin-bottom:8px; }
    .slider { width:100%; accent-color:var(--accent); }
    button { background:var(--accent); border:none; color:#fff;
             padding:10px 14px; border-radius:6px; margin-right:6px; }
    .spinner { display:none; margin-top:10px; }
  </style>
</head>

<body>
<div class="container">
  <h2>Edit {{ filename }}</h2>

  <audio id="player" controls playsinline preload="metadata"></audio>

  <div style="margin-bottom:10px;">
    <button type="button" onclick="playFromStart()">Play From Start</button>
    <button type="button" onclick="playSelection()">Play Selection</button>
  </div>

  <p>
    Start: <span id="startVal">0</span>s
    <input class="slider" type="range" id="start" min="0" step="0.1">
  </p>

  <p>
    End: <span id="endVal">0</span>s
    <input class="slider" type="range" id="end" min="0" step="0.1">
  </p>

  <form method="post" action="/trim" onsubmit="return submitTimes()">
    <input type="hidden" name="filename" value="{{ filename }}">
    <input type="hidden" name="start" id="startInput">
    <input type="hidden" name="end" id="endInput">
    <button type="submit">Save (Overwrite)</button>
    <a href="/" style="margin-left:10px;">Cancel</a>
  </form>

  <div class="spinner" id="spinner">⏳ Trimming…</div>
</div>

<script>
  const audio = document.getElementById("player");
  const startSlider = document.getElementById("start");
  const endSlider = document.getElementById("end");
  const startVal = document.getElementById("startVal");
  const endVal = document.getElementById("endVal");
  const startInput = document.getElementById("startInput");
  const endInput = document.getElementById("endInput");
  const spinner = document.getElementById("spinner");

  audio.src = `/download/{{ filename }}?v=${Date.now()}`;

  audio.addEventListener("loadedmetadata", () => {
    startSlider.max = audio.duration;
    endSlider.max = audio.duration;
    startSlider.value = 0;
    endSlider.value = audio.duration;
    startVal.textContent = "0.0";
    endVal.textContent = audio.duration.toFixed(1);
  });

  startSlider.oninput = () => {
    if (+startSlider.value >= +endSlider.value) {
      startSlider.value = endSlider.value - 0.1;
    }
    startVal.textContent = startSlider.value;
  };

  endSlider.oninput = () => {
    if (+endSlider.value <= +startSlider.value) {
      endSlider.value = +startSlider.value + 0.1;
    }
    endVal.textContent = endSlider.value;
  };

  function playFromStart() {
    audio.currentTime = startSlider.value;
    audio.play();
  }

  function playSelection() {
    audio.currentTime = startSlider.value;
    audio.play();
  }

  function submitTimes() {
    startInput.value = startSlider.value;
    endInput.value = endSlider.value;
    spinner.style.display = "block";
    return true;
  }
</script>
</body>
</html>
